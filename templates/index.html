<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель управления "Николай"</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        body { background-color: #212529; color: #fff; }
        .container { max-width: 1140px; }
        /* ИЗМЕНЕНО: Теперь все эти элементы будут чисто белыми */
        h1, h2, h3, h4, h5, h6, p, label, .card-header, .nav-link { color: #fff !important; } 
        .card { background-color: #343a40; border-color: #495057; }
        .card-header { background-color: #495057; border-bottom: 1px solid #495057; }
        .form-control, .form-select { background-color: #495057; color: #fff; border-color: #6c757d; }
        .form-control::placeholder { color: #ccc; }
        .form-control:focus, .form-select:focus { background-color: #495057; color: #fff; border-color: #86b7fe; box-shadow: none; }
        .status-dot { height: 25px; width: 25px; border-radius: 50%; display: inline-block; vertical-align: middle; }
        .status-ok { background-color: #198754; }
        .status-fail { background-color: #dc3545; }
        #logs { background-color: #1a1a1a; color: #f8f9fa; font-family: monospace; white-space: pre-wrap; height: 400px; overflow-y: scroll; border: 1px solid #495057; }
        
        /* Стили для вкладок */
        .nav-tabs { border-bottom: none; } /* Убираем белую полоску */
        .nav-tabs .nav-link { border-color: #495057; }
        .nav-tabs .nav-link.active { background-color: #495057; border-color: #495057; }
        .tab-content > .tab-pane .card-body { min-height: 650px; } /* Одинаковая высота для всех вкладок */

        /* Стили для чата */
        #chat-history { background-color: #2c3034; height: 500px; overflow-y: scroll; border: 1px solid #495057; padding: 10px; margin-bottom: 1rem; }
        .message-block { display: flex; flex-direction: column; margin-bottom: 0.5rem; max-width: 80%; }
        .message-content { padding: 0.5rem 1rem; border-radius: 0.5rem; word-wrap: break-word; }
        .message-time { font-size: 0.75rem; color: #adb5bd; margin-top: 4px; }
        .user-message { align-self: flex-end; }
        .user-message .message-content { background-color: #0d6efd; text-align: left; }
        .user-message .message-time { text-align: right; }
        .ai-message { align-self: flex-start; }
        .ai-message .message-content { background-color: #495057; text-align: left; white-space: pre-wrap; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; }

        /* Стили для Базы Знаний */
        .document-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #495057; }
        .document-item span { color: #f8f9fa; }
        .upload-area { display: flex; gap: 1rem; align-items: center; }
        .upload-area .btn-upload { flex-shrink: 0; }
        .file-name-display { background-color: #495057; padding: 0.375rem 0.75rem; border-radius: 0.25rem; border: 1px solid #6c757d; flex-grow: 1; text-align: left; color: #ccc; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #uploadButton:disabled { background-color: #6c757d; cursor: not-allowed; }
        .pagination { justify-content: center; }
    </style>
</head>
<body>
    <div class="container my-4">
        <h1 class="mb-4">Панель управления "Николай"</h1>

        <div class="card mb-4">
            <div class="card-header">Статус и Логи</div>
            <div class="card-body">
                <p>Статус сервиса: <span id="status-indicator" class="status-dot"></span> <span id="status-text">Загрузка...</span></p>
                <button class="btn btn-primary mb-2" onclick="fetchLogs()">Обновить логи</button>
                <div id="logs" class="p-2 rounded">Загрузка логов...</div>
            </div>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="rag-tab" data-bs-toggle="tab" data-bs-target="#rag-tab-pane" type="button">База Знаний (RAG)</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat-tab-pane" type="button">Тестовый чат</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-tab-pane" type="button">Настройки</button></li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="rag-tab-pane" role="tabpanel">
                <div class="card card-body border-top-0 rounded-bottom">
                    <h5>Загрузить новый документ</h5>
                    <form id="uploadForm" class="mb-3">
                        <div class="upload-area">
                            <label for="documentFile" class="btn btn-secondary btn-upload">Выберите файл</label>
                            <span id="fileNameDisplay" class="file-name-display">Файл не выбран</span>
                            <button class="btn btn-success" type="submit" id="uploadButton" disabled>Загрузить</button>
                        </div>
                        <input type="file" id="documentFile" class="d-none">
                    </form>
                    <div id="uploadStatus"></div>
                    <h5 class="mt-4">Загруженные документы</h5>
                    <div id="documentList">Загрузка списка...</div>
                    <nav id="pagination-wrapper" class="mt-4"></nav>
                </div>
            </div>

            <div class="tab-pane fade" id="chat-tab-pane" role="tabpanel">
                <div class="card card-body border-top-0 rounded-bottom">
                    <div class="chat-header mb-2">
                        <h5>Тестовый чат для отладки промптов</h5>
                        <button class="btn btn-sm btn-outline-light" id="clearChatBtn" title="Очистить чат"><i class="bi bi-arrow-clockwise"></i> Очистить</button>
                    </div>
                    <div id="chat-history"></div>
                    <div class="input-group">
                        <textarea class="form-control" id="user-input" placeholder="Введите ваш запрос здесь... (Shift+Enter для переноса строки)" rows="3"></textarea>
                        <button class="btn btn-primary" id="send-btn">Отправить</button>
                    </div>
                    <div id="loading-indicator" class="mt-2" style="display: none;">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span>Думаю...</span>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="settings-tab-pane" role="tabpanel">
                <div class="card card-body border-top-0 rounded-bottom">
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label for="model" class="form-label">Выбрать модель</label>
                            <select class="form-select" id="model" name="model"></select>
                        </div>
                        <div class="mb-3">
                            <label for="prompt" class="form-label">Системный промпт</label>
                            <textarea class="form-control" id="prompt" name="prompt" rows="15"></textarea>
                        </div>
                        
                        <!-- НОВЫЙ ПЕРЕКЛЮЧАТЕЛЬ ДЛЯ RAG -->
                        <div class="form-group mb-3 form-check form-switch">
                            <input type="checkbox" class="form-check-input" id="use_rag_toggle" name="use_rag" value="true">
                            <label class="form-check-label" for="use_rag_toggle">Использовать Базу Знаний (RAG)</label>
                            <!-- ИЗМЕНЕНО: Класс text-muted заменен на text-light -->
                            <small class="form-text text-light">Отключите, если хотите, чтобы ИИ отвечал только на основе системного промпта, без использования загруженных документов.</small>
                        </div>
                        <!-- КОНЕЦ НОВОГО ПЕРЕКЛЮЧАТЕЛЯ -->

                        <button type="submit" class="btn btn-success">Сохранить и Перезапустить</button>
                    </form>
                    <div id="saveStatus" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- Глобальные переменные для пагинации ---
    let allDocuments = [];
    let currentPage = 1;
    const itemsPerPage = 5;

    // --- Логика для Базы Знаний ---
    const uploadForm = document.getElementById('uploadForm');
    const documentFile = document.getElementById('documentFile');
    const uploadButton = document.getElementById('uploadButton');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const uploadStatus = document.getElementById('uploadStatus');
    const documentList = document.getElementById('documentList');
    const paginationWrapper = document.getElementById('pagination-wrapper');

    documentFile.addEventListener('change', () => {
        if (documentFile.files.length > 0) {
            fileNameDisplay.textContent = documentFile.files[0].name;
            fileNameDisplay.style.color = '#fff';
            uploadButton.disabled = false;
        } else {
            fileNameDisplay.textContent = 'Файл не выбран';
            fileNameDisplay.style.color = '#ccc';
            uploadButton.disabled = true;
        }
    });

    function displayDocuments(page) {
        currentPage = page;
        documentList.innerHTML = '';
        paginationWrapper.innerHTML = '';

        if (allDocuments.length === 0) {
            documentList.innerHTML = '<p>Документы не загружены.</p>';
            return;
        }

        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedItems = allDocuments.slice(startIndex, endIndex);

        paginatedItems.forEach(doc => {
            const docElement = document.createElement('div');
            docElement.className = 'document-item';
            docElement.innerHTML = `<span>${doc}</span><button class="btn btn-danger btn-sm" onclick="deleteDocument('${doc}')">Удалить</button>`;
            documentList.appendChild(docElement);
        });

        setupPagination();
    }

    function setupPagination() {
        const pageCount = Math.ceil(allDocuments.length / itemsPerPage);
        if (pageCount <= 1) return;

        const ul = document.createElement('ul');
        ul.className = 'pagination';

        for (let i = 1; i <= pageCount; i++) {
            const li = document.createElement('li');
            li.className = 'page-item' + (i === currentPage ? ' active' : '');
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.innerText = i;
            a.addEventListener('click', (e) => {
                e.preventDefault();
                displayDocuments(i);
            });
            li.appendChild(a);
            ul.appendChild(li);
        }
        paginationWrapper.appendChild(ul);
    }

    async function fetchDocuments() {
        documentList.innerHTML = 'Обновление...';
        try {
            const response = await fetch('/api/documents');
            const data = await response.json();
            allDocuments = data.documents || [];
            displayDocuments(1);
        } catch (error) {
            documentList.innerHTML = '<p class="text-danger">Ошибка загрузки списка документов.</p>';
        }
    }
    
    uploadForm.addEventListener('submit', async (e) => { /* ... код без изменений ... */ });
    async function deleteDocument(filename) { /* ... код без изменений ... */ }

    // --- Остальная логика ---
    const sendBtn = document.getElementById('send-btn');
    const userInput = document.getElementById('user-input');
    const chatHistory = document.getElementById('chat-history');
    const loadingIndicator = document.getElementById('loading-indicator');
    const clearChatBtn = document.getElementById('clearChatBtn');

    clearChatBtn.addEventListener('click', () => {
        chatHistory.innerHTML = '';
    });

    function addMessageToHistory(message, sender) {
        const time = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        const messageBlock = document.createElement('div');
        messageBlock.className = `message-block ${sender}-message`;
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        messageContent.textContent = message;

        const messageTime = document.createElement('div');
        messageTime.className = 'message-time';
        messageTime.textContent = time;

        messageBlock.appendChild(messageContent);
        messageBlock.appendChild(messageTime);
        chatHistory.appendChild(messageBlock);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    
    sendBtn.addEventListener('click', async () => { /* ... код без изменений ... */ });
    userInput.addEventListener('keydown', (e) => { /* ... код без изменений ... */ });
    async function fetchStatus() { /* ... код без изменений ... */ }
    async function fetchLogs() { /* ... код без изменений ... */ }
    
    // ИЗМЕНЕННАЯ ФУНКЦИЯ fetchSettings
    async function fetchSettings() {
        const response = await fetch('/api/settings');
        const data = await response.json();
        document.getElementById('prompt').value = data.prompt;
        const modelSelect = document.getElementById('model');
        modelSelect.innerHTML = '';
        data.models_list.forEach(modelName => {
            const option = document.createElement('option');
            option.value = modelName;
            option.textContent = modelName;
            if (modelName === data.current_model) { option.selected = true; }
            modelSelect.appendChild(option);
        });
        // Установка состояния чекбокса RAG
        document.getElementById('use_rag_toggle').checked = data.use_rag; // <-- НОВАЯ СТРОКА
    }

    document.getElementById('settingsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        // FormData автоматически обрабатывает чекбоксы:
        // если checked, то 'use_rag=true' будет в formData
        // если unchecked, то 'use_rag' не будет в formData, и FastAPI Form(False) обработает это как False
        
        const saveStatus = document.getElementById('saveStatus');
        saveStatus.innerHTML = '<div class="alert alert-info">Сохраняю...</div>';
        const response = await fetch('/api/settings', { method: 'POST', body: formData });
        const result = await response.json();
        if (result.status === 'ok') { saveStatus.innerHTML = `<div class="alert alert-success">Настройки сохранены! Сервис перезапускается.</div>`; }
        else { saveStatus.innerHTML = `<div class="alert alert-danger">Ошибка сохранения.</div>`; }
        setTimeout(() => { saveStatus.innerHTML = ''; }, 5000);
    });

    // --- Полный код для всех функций (чтобы ничего не потерялось) ---
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!documentFile.files[0]) { alert('Выберите файл для загрузки.'); return; }
        const formData = new FormData();
        formData.append('file', documentFile.files[0]);
        uploadStatus.innerHTML = '<div class="alert alert-info">Загрузка и обработка файла...</div>';
        try {
            const response = await fetch('/api/upload-document', { method: 'POST', body: formData });
            const result = await response.json();
            if (response.ok) {
                uploadStatus.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                fetchDocuments();
            } else { throw new Error(result.detail || 'Ошибка загрузки'); }
        } catch (error) {
            uploadStatus.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
        documentFile.value = '';
        fileNameDisplay.textContent = 'Файл не выбран';
        fileNameDisplay.style.color = '#ccc';
        uploadButton.disabled = true;
        setTimeout(() => { uploadStatus.innerHTML = ''; }, 5000);
    });
    async function deleteDocument(filename) {
        if (!confirm(`Вы уверены, что хотите удалить файл "${filename}"?`)) return;
        try {
            const response = await fetch(`/api/documents/${filename}`, { method: 'DELETE' });
            if (response.ok) {
                alert(`Файл "${filename}" удален.`);
                fetchDocuments();
            } else { throw new Error('Ошибка удаления'); }
        } catch (error) { alert(error.message); }
    }
    sendBtn.addEventListener('click', async () => {
        const message = userInput.value.trim();
        if (!message) return;
        addMessageToHistory(message, 'user');
        userInput.value = '';
        loadingIndicator.style.display = 'block';
        sendBtn.disabled = true;
        try {
            const response = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_message: message }) });
            if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || `Ошибка сервера: ${response.statusText}`); }
            const data = await response.json();
            addMessageToHistory(data.ai_response, 'ai');
        } catch (error) {
            addMessageToHistory(`Ошибка: ${error.message}`, 'ai');
        } finally {
            loadingIndicator.style.display = 'none';
            sendBtn.disabled = false;
        }
    });
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendBtn.click(); }
    });
    async function fetchStatus() {
        const response = await fetch('/api/status');
        const data = await response.json();
        const indicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        indicator.className = 'status-dot';
        if (data.status === 'active') { indicator.classList.add('status-ok'); statusText.textContent = 'Работает'; }
        else { indicator.classList.add('status-fail'); statusText.textContent = 'Остановлен или ошибка'; }
    }
    async function fetchLogs() {
        const logsContainer = document.getElementById('logs');
        logsContainer.textContent = 'Обновление...';
        try {
            const response = await fetch('/api/logs');
            const data = await response.json();
            logsContainer.textContent = data.logs || 'Логи за последние 5 минут пусты.';
            logsContainer.scrollTop = logsContainer.scrollHeight;
        } catch (error) { logsContainer.textContent = 'Не удалось загрузить логи.'; }
    }
    
    window.onload = () => {
        fetchStatus();
        fetchLogs();
        fetchSettings(); // Эта функция теперь загружает и состояние RAG
        fetchDocuments();
        setInterval(fetchStatus, 5000);
    };
</script>
</body>
</html>
