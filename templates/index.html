<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админка для Бати</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .status-dot { height: 25px; width: 25px; border-radius: 50%; display: inline-block; }
        .status-ok { background-color: #198754; }
        .status-fail { background-color: #dc3545; }
        #logs { background-color: #212529; color: #f8f9fa; font-family: monospace; white-space: pre-wrap; height: 400px; overflow-y: scroll; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Панель управления "Николай"</h1>

        <!-- Статус и Логи -->
        <div class="card mb-4">
            <div class="card-header">Статус и Логи</div>
            <div class="card-body">
                <p>Статус сервиса: <span id="status-indicator" class="status-dot"></span> <span id="status-text">Загрузка...</span></p>
                <button class="btn btn-primary mb-2" onclick="fetchLogs()">Обновить логи</button>
                <div id="logs" class="p-2 rounded">Загрузка логов...</div>
            </div>
        </div>

        <!-- Настройки -->
        <div class="card">
            <div class="card-header">Настройки Промпта и Модели</div>
            <div class="card-body">
                <form id="settingsForm">
                    <div class="mb-3">
                        <label for="model" class="form-label">Выбрать модель OpenAI</label>
                        <select class="form-select" id="model" name="model">
                            <!-- Опции будут загружены сюда -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="prompt" class="form-label">Системный промпт</label>
                        <textarea class="form-control" id="prompt" name="prompt" rows="10"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">Сохранить и Перезапустить</button>
                </form>
                <div id="saveStatus" class="mt-3"></div>
            </div>
        </div>
    </div>

<script>
    // Функция для получения статуса
    async function fetchStatus() {
        const response = await fetch('/api/status');
        const data = await response.json();
        const indicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        indicator.className = 'status-dot';
        if (data.status === 'active') {
            indicator.classList.add('status-ok');
            statusText.textContent = 'Работает';
        } else {
            indicator.classList.add('status-fail');
            statusText.textContent = 'Остановлен или ошибка';
        }
    }

    // Функция для получения логов
    async function fetchLogs() {
        const response = await fetch('/api/logs');
        const data = await response.json();
        document.getElementById('logs').textContent = data.logs;
    }

    // Функция для получения текущих настроек
    async function fetchSettings() {
        const response = await fetch('/api/settings');
        const data = await response.json();
        
        // Заполняем промпт
        document.getElementById('prompt').value = data.prompt;

        // Заполняем выпадающий список моделей
        const modelSelect = document.getElementById('model');
        modelSelect.innerHTML = ''; // Очищаем список
        data.models_list.forEach(modelName => {
            const option = document.createElement('option');
            option.value = modelName;
            option.textContent = modelName;
            if (modelName === data.current_model) {
                option.selected = true; // Выбираем текущую модель
            }
            modelSelect.appendChild(option);
        });
    }
    
    // Сохранение настроек
    document.getElementById('settingsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const saveStatus = document.getElementById('saveStatus');
        saveStatus.innerHTML = '<div class="alert alert-info">Сохраняю...</div>';

        const response = await fetch('/api/settings', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        
        if (result.status === 'ok') {
            saveStatus.innerHTML = '<div class="alert alert-success">Настройки сохранены! Сервис перезапускается.</div>';
        } else {
            saveStatus.innerHTML = '<div class="alert alert-danger">Ошибка сохранения.</div>';
        }
        setTimeout(() => { saveStatus.innerHTML = ''; }, 5000);
    });

    // Первоначальная загрузка данных
    window.onload = () => {
        fetchStatus();
        fetchLogs();
        fetchSettings();
        setInterval(fetchStatus, 5000); // Обновляем статус каждые 5 секунд
    };
</script>
</body>
</html>
