<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админка для ИИ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #212529; color: #fff; }
        h1, h2, h3, h4, h5, h6,
        p, label, .card-header {
            color: #f8f9fa !important;
        }
        .card { background-color: #343a40; border-color: #495057; }
        .card-header { background-color: #495057; border-bottom: 1px solid #495057; }
        .form-control, .form-select { background-color: #495057; color: #fff; border-color: #6c757d; }
        .form-control::placeholder { color: #ccc; }
        .form-control:focus, .form-select:focus { background-color: #495057; color: #fff; border-color: #86b7fe; box-shadow: none; }
        .status-dot { height: 25px; width: 25px; border-radius: 50%; display: inline-block; vertical-align: middle; }
        .status-ok { background-color: #198754; }
        .status-fail { background-color: #dc3545; }
        #logs { background-color: #1a1a1a; color: #f8f9fa; font-family: monospace; white-space: pre-wrap; height: 400px; overflow-y: scroll; border: 1px solid #495057; }
        
        #chat-history {
            background-color: #2c3034;
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #495057;
            padding: 10px;
            margin-bottom: 1rem;
        }
        #chat-history p {
            margin-bottom: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            max-width: 80%;
            word-wrap: break-word;
            width: fit-content; /* <<< ИЗМЕНЕНИЕ ЗДЕСЬ */
        }
        .user-message {
            background-color: #0d6efd;
            margin-left: auto;
            text-align: right;
        }
        .ai-message {
            background-color: #495057;
            margin-right: auto;
            text-align: left;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Панель управления "Николай"</h1>

        <!-- Статус и Логи -->
        <div class="card mb-4">
            <div class="card-header">Статус и Логи</div>
            <div class="card-body">
                <p>Статус сервиса: <span id="status-indicator" class="status-dot"></span> <span id="status-text">Загрузка...</span></p>
                <button class="btn btn-primary mb-2" onclick="fetchLogs()">Обновить логи</button>
                <div id="logs" class="p-2 rounded">Загрузка логов...</div>
            </div>
        </div>

        <!-- Тестовый чат -->
        <div class="card mb-4">
            <div class="card-header">Тестовый чат для отладки промптов</div>
            <div class="card-body">
                <div id="chat-history"></div>
                <div class="input-group">
                    <textarea class="form-control" id="user-input" placeholder="Введите ваш запрос здесь..." rows="3"></textarea>
                    <button class="btn btn-primary" id="send-btn">Отправить</button>
                </div>
                <div id="loading-indicator" class="mt-2" style="display: none;">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Думаю...</span>
                </div>
            </div>
        </div>

        <!-- Настройки -->
        <div class="card">
            <div class="card-header">Настройки Промпта и Модели</div>
            <div class="card-body">
                <form id="settingsForm">
                    <div class="mb-3">
                        <label for="model" class="form-label">Выбрать модель OpenAI</label>
                        <select class="form-select" id="model" name="model"></select>
                    </div>
                    <div class="mb-3">
                        <label for="prompt" class="form-label">Системный промпт</label>
                        <textarea class="form-control" id="prompt" name="prompt" rows="10"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">Сохранить и Перезапустить</button>
                </form>
                <div id="saveStatus" class="mt-3"></div>
            </div>
        </div>
    </div>

<script>
    // --- Логика чата ---
    const sendBtn = document.getElementById('send-btn');
    const userInput = document.getElementById('user-input');
    const chatHistory = document.getElementById('chat-history');
    const loadingIndicator = document.getElementById('loading-indicator');

    function addMessageToHistory(message, sender) {
        const p = document.createElement('p');
        p.className = sender === 'user' ? 'user-message' : 'ai-message';
        p.textContent = message;
        chatHistory.appendChild(p);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    sendBtn.addEventListener('click', async () => {
        const message = userInput.value.trim();
        if (!message) return;
        addMessageToHistory(message, 'user');
        userInput.value = '';
        loadingIndicator.style.display = 'block';
        sendBtn.disabled = true;
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_message: message })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Ошибка сервера: ${response.statusText}`);
            }
            const data = await response.json();
            addMessageToHistory(data.ai_response, 'ai');
        } catch (error) {
            addMessageToHistory(`Ошибка: ${error.message}`, 'ai');
        } finally {
            loadingIndicator.style.display = 'none';
            sendBtn.disabled = false;
        }
    });

    // --- Остальная логика ---
    async function fetchStatus() {
        const response = await fetch('/api/status');
        const data = await response.json();
        const indicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        indicator.className = 'status-dot';
        if (data.status === 'active') {
            indicator.classList.add('status-ok');
            statusText.textContent = 'Работает';
        } else {
            indicator.classList.add('status-fail');
            statusText.textContent = 'Остановлен или ошибка';
        }
    }

    async function fetchLogs() {
        const response = await fetch('/api/logs');
        const data = await response.json();
        document.getElementById('logs').textContent = data.logs;
    }

    async function fetchSettings() {
        const response = await fetch('/api/settings');
        const data = await response.json();
        document.getElementById('prompt').value = data.prompt;
        const modelSelect = document.getElementById('model');
        modelSelect.innerHTML = '';
        data.models_list.forEach(modelName => {
            const option = document.createElement('option');
            option.value = modelName;
            option.textContent = modelName;
            if (modelName === data.current_model) {
                option.selected = true;
            }
            modelSelect.appendChild(option);
        });
    }

    document.getElementById('settingsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const saveStatus = document.getElementById('saveStatus');
        saveStatus.innerHTML = '<div class="alert alert-info">Сохраняю...</div>';
        const response = await fetch('/api/settings', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.status === 'ok') {
            saveStatus.innerHTML = '<div class="alert alert-success">Настройки сохранены! Сервис перезапускается.</div>';
        } else {
            saveStatus.innerHTML = '<div class="alert alert-danger">Ошибка сохранения.</div>';
        }
        setTimeout(() => { saveStatus.innerHTML = ''; }, 5000);
    });

    window.onload = () => {
        fetchStatus();
        fetchLogs();
        fetchSettings();
        setInterval(fetchStatus, 5000);
    };
</script>
</body>
</html>
